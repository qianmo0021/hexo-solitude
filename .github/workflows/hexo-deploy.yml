name: éƒ¨ç½² Hexo å¹¶æ›´æ–°å‹é“¾æ•°æ®

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šè®¾ç½® Node.js ç¯å¢ƒï¼ˆå¸¦ npm ç¼“å­˜ï¼‰
      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          npm install -g hexo-cli
          npm install

      # æ­¥éª¤4ï¼šæ‰§è¡Œ link.js è„šæœ¬ç”Ÿæˆ solitude_flink_count.json
      - name: ğŸ“ ç”Ÿæˆå‹é“¾ç»Ÿè®¡æ–‡ä»¶
        run: node link.js

      # æ­¥éª¤5ï¼šé€šè¿‡ API æ›´æ–°åˆ°å¦ä¸€ä¸ªä»“åº“
      - name: ğŸ”„ æ¨é€å‹é“¾ç»Ÿè®¡æ–‡ä»¶åˆ°å¤–éƒ¨ä»“åº“
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          FILE="./source/solitude_flink_count.json"
          REPO="qianmo0021/link"
          TARGET=$(basename "$FILE")

          echo "å¼€å§‹å¤„ç†æ–‡ä»¶: $TARGET"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          RESPONSE=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/contents/$TARGET")

          if echo "$RESPONSE" | jq -e '.sha' >/dev/null 2>&1; then
            SHA=$(echo "$RESPONSE" | jq -r '.sha')
            echo "æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°†æ‰§è¡Œæ›´æ–°"
          else
            SHA=""
            echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
          fi

          CONTENT=$(base64 -w0 "$FILE")

          jq -n \
            --arg msg "è‡ªåŠ¨æ›´æ–° $TARGET äº $(date +'%Y-%m-%d %H:%M:%S')" \
            --arg content "$CONTENT" \
            --arg sha "$SHA" \
            '{
              message: $msg,
              content: $content,
              sha: $sha
            }' > payload.json

          curl -s -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://api.github.com/repos/$REPO/contents/$TARGET"

          echo "âœ… æ–‡ä»¶ $TARGET å·²æˆåŠŸæ¨é€åˆ° $REPO"

      # æ­¥éª¤6ï¼šæ„å»º Hexo
      - name: ğŸ—ï¸ æ„å»º Hexo é™æ€æ–‡ä»¶/æ›´æ–°è¿½ç•ªé¡µ
        run: |
          hexo bangumi -u
          hexo clean
          hexo generate

      # æ­¥éª¤7ï¼šéƒ¨ç½²åˆ° GitHub Pages
      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
