name: "ðŸš€ Hexo å…¨è‡ªåŠ¨éƒ¨ç½²ï¼ˆæžé€Ÿç¼“å­˜ç‰ˆï¼‰"

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"  # æ¯æ—¥UTC 0ç‚¹è‡ªåŠ¨æž„å»ºï¼ˆå¯é€‰ï¼‰

env:
  TZ: Asia/Shanghai

jobs:
  deploy:
    name: "ðŸ› ï¸ æž„å»ºä¸Žéƒ¨ç½²"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ========== åˆå§‹åŒ–é˜¶æ®µ ==========
      - name: "ðŸ” æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive  # å¦‚æžœä¸»é¢˜æ˜¯å­æ¨¡å—éœ€è¦æ­¤é¡¹

      # ========== ç¼“å­˜åŠ é€Ÿé˜¶æ®µ ==========
      - name: "ðŸ’¾ ç¼“å­˜ç³»ç»Ÿä¾èµ–"
        id: cache-apt
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: "ðŸ’¾ ç¼“å­˜Nodeæ¨¡å—"
        id: cache-node
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            themes/**/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      # ========== ä¾èµ–å®‰è£… ==========
      - name: "âš¡ æ™ºèƒ½å®‰è£…ç³»ç»Ÿå·¥å…·"
        run: |
          # ä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶æ›´æ–°
          if [ "${{ steps.cache-apt.outputs.cache-hit }}" != 'true' ]; then
            sudo apt-get update -qq
          fi

          # æŒ‰éœ€å®‰è£…æ ¸å¿ƒå·¥å…·
          for tool in jq curl git; do
            if ! command -v $tool &>/dev/null; then
              sudo apt-get install -y --no-install-recommends $tool
            fi
          done

      - name: "ðŸ“¦ å®‰è£…NodeçŽ¯å¢ƒ"
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: npm  # è‡ªåŠ¨ç¼“å­˜npmåŒ…

      - name: "ðŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–"
        run: |
          # ä»…åœ¨node_modulesä¸å­˜åœ¨æ—¶å®‰è£…
          if [ ! -d "node_modules" ]; then
            npm install -g hexo-cli
            npm install yamljs --save
            npm install --audit=false
          fi

      # ========== å‹é“¾å¤„ç† ==========
      - name: "ðŸ› ï¸ åˆå§‹åŒ–å‹é“¾æ•°æ®"
        run: |
          mkdir -p source/_data
          if [ ! -f "source/_data/link.yml" ]; then
            echo "::warning::ç”Ÿæˆç¤ºä¾‹å‹é“¾æ•°æ®"
            cat > source/_data/link.yml <<'EOF'
            - name: "é»˜è®¤å‹é“¾"
              url: "https://example.com"
              avatar: "/images/default.png"
            EOF
          fi

      - name: "ðŸ¤ ç”Ÿæˆå‹é“¾JSON"
        run: |
          echo "::group::ðŸ“Š æ–‡ä»¶ç»“æž„"
          ls -la source/_data/
          echo "::endgroup::"

          if ! node link.js; then
            echo "::error::ç”Ÿæˆå‹é“¾æ•°æ®å¤±è´¥"
            exit 1
          fi
          ls -lh ./source/solitude_flink_count.json

      # ========== Hexoæž„å»º ==========
      - name: "ðŸ—ï¸ æž„å»ºHexoç«™ç‚¹"
        run: |
          hexo clean
          hexo generate --debug
          du -sh public  # æ˜¾ç¤ºæž„å»ºå¤§å°

      # ========== éƒ¨ç½²é˜¶æ®µ ==========
      - name: "ðŸš€ éƒ¨ç½²åˆ°GitHub Pages"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
          user_name: "GitHub Actions"
          user_email: "41898282+github-actions[bot]@users.noreply.github.com"

      # ========== é€šçŸ¥é˜¶æ®µ ==========
      - name: "ðŸ“¢ éƒ¨ç½²ç»“æžœ"
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice::ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "::error::âŒ éƒ¨ç½²å¤±è´¥"
          fi